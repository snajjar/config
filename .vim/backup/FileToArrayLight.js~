var description = require('./package.json');
var DualBox = require('@dualbox/dualbox');
var DualboxTypesAll3D = require('@dualbox/dualbox-type-all3d');

var File = require('@dualbox/dualbox-type-file');

var JSZip = require('@dualbox/lib-jszip');

var getFileInZip = function(file, callback){
    JSZip.loadAsync(file.toArrayBuffer()).then(
        function (zip) {
            // Auto find the file in zip.
            // Note that this module works on zip file only
            // if there is no more than 1 file.
            var fn = "";
            zip.forEach(function (relativePath, file){
                fn = relativePath;
            });
            var f = zip.file(fn);
            var fext = fn.split('.').pop().toLowerCase();
            if(fext === "json"){
                f.async("string").then(
                    function(data){
                        callback(data,"string",fext);
                    }
                );
            }else{
                throw new DualBox.errors.RuntimeError('Cannot read file in zip, the file found in the zip is not a supported format, please provide JSON. Detected type is '+fext);
            }
        }
    ).catch(
        function(reason) {
            throw new DualBox.errors.RuntimeError('Cannot read zip file ('+ file.getName() + ') : Zip load has been rejected : '+reason+'.');
        }
    );
};

var parseAndLoad = function(data){
    var data = JSON.parse(data);
    var res = null;
    if(data.type !== undefined && data.value !== undefined && data.type.toLowerCase() === "array<light>"){
        res = DualBox.Type.loadFromJSON(data.type, data.value);
    }else{
        // in this case we suppose that the file contains only the data, not the type
        res = DualBox.Type.loadFromJSON("array<light>", data);
    }
    return res;
};

/**
 *  A simple conditional module for DualBox.
 *  @constructor
 *  @extends {DualBox.Module}
 */
var FileToArrayLight = function(attrs){
    DualBox.Module.call(this, description, attrs);
    this.setParallel(false);
};

FileToArrayLight.prototype = Object.create(DualBox.Module.prototype);
FileToArrayLight.prototype.constructor = FileToArrayLight;

// [Abstract] See DualBox.Module
FileToArrayLight.prototype.compute = function(input, response){
    this.debug( "Computing output of FileToArrayLight" );

    var done = function(arr_l){

        var output = {
            arr:arr_l
        };
        response.send(output);
    };

    if(input.file === null){
        done([]);
    }else{
        switch(input.file.getExtension()){
            case "json":
                var res = parseAndLoad(input.file.toUTF8String());
                done(res);
            break;
            case "zip":
                getFileInZip(input.file, function(data, type, ext){
                    switch(ext){
                        case "json":
                            var res = parseAndLoad(data);
                            done(res);
                        break;
                        default:
                            throw new DualBox.errors.TypeError("Error in module " + this.id +" the file extension in the zip file. Please provide a valid JSON file. Detected is : "+ext);
                        break;
                    };
                });
            break;
            default:
                throw new DualBox.errors.TypeError("Error in module " + this.id +" the file extension is not supported. Please provide a valid JSON file.");
            break;
        };
    }
};

module.exports = FileToArrayLight;

