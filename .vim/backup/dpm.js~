#! /usr/bin/env node

require('exit-code');

// Define some global helpers
if (!String.prototype.format) {
  String.prototype.format = function() {
    var args = arguments;
    return this.replace(/{(\d+)}/g, function(match, number) {
      return typeof args[number] != 'undefined'
        ? args[number]
        : match
      ;
    });
  };
}

var pjson = require('../package.json');

var help = function() {
    var helper = require("./help.js");
    helper.handle([]);
    process.exit(1);
}

// handle a specific command by requiring the right .js file
var handleCommand = function( args ) {
    var command = args[0];
    if( command === undefined ) {
        help();
    }

    try {
        var handler = require('./' + command + '.js');
        return handler.handle(args.slice(1));
    }
    catch( e ) {
        if( e.code == "MODULE_NOT_FOUND" ) {
            console.error("Error catched: " + e);
            console.error("No command named " + command + "\n");
            help();
        }
        else {
            throw e;
        }
    }
}

var main = function() {
    var args = process.argv.slice(2);
    var ret = handleCommand( args );
    return ret;
};



if (require.main === module) {
    var ret = main();
    if( ret instanceof Promise ) {
        // if it's a Promise, handle it properly
        ret.then((code) => {
            console.log('Setting exitcode to: ' + code + ' (promise)');
            process.exitCode = code;
        }).catch( (e) => {
            console.log('Setting exitcode to: -1 (promise)');
            process.exitCode = -1;
        });;
    }
    else {
        console.log('Setting exitcode to: ' + ret);
        process.exitCode = ret;
    }
} else {
    module.exports = {
        "DpmCache" : require('../lib/dpmcache')
    };
}
