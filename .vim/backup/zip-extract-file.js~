var DualBox = require('@dualbox/dualbox');
var description = require('./package.json');

var File = require('@dualbox/dualbox-type-file');

var JSZip = require('jszip');

/**
 *  Module to get the file content in a zip.
 *  This module is smart and will return :
 *  @constructor
 *  @extends {DualBox.Module}
 */
var ZipExtractFile = function(attrs){
    DualBox.Module.call(this, description, attrs);
};
ZipExtractFile.prototype = Object.create(DualBox.Module.prototype);
ZipExtractFile.prototype.constructor = ZipExtractFile;

// [Abstract] See DualBox.Module
ZipExtractFile.prototype.compute = function(input, response){
    this.debug( "Computing output of ZipExtractFile" );

    var that = this;
    JSZip.loadAsync(input.zip.toArrayBuffer()).then(
        function (zip) {
            var fn = input.filename;
            if(fn === null){
                // Filename is optional is the zip contains only 1 file,
                // get this file.
                zip.forEach(function (relativePath, file){
                    fn = relativePath;
                });
            }
            var fext = fn.split('.').pop();
            var f = zip.file(fn);
            if(f === null){
                // check for jpeg shit.
                if(fext === "jpeg"){
                    f = zip.file(fn.slice(0,fn.length-4)+"jpg");
                }else if(fext === "jpg"){
                    f = zip.file(fn.slice(0,fn.length-3)+"jpeg");
                }
            }
            if(f === null){
                throw "Cannot find the requested file in the zip. Module concerned : "+this.id+" File concerned : "+fn;
            }

            fn = fn.slice(0,fn.length-fext.length-1);
            f.async("arraybuffer").then(
                function(data){
                    var output = {
                        file:new File(data,fext,fn)
                    };
                    response.send(output);
                }
            );
        }
    ).catch(
        function(reason) {
            console.error('Cannot read zip file ('+ input.filename+ ') : Zip load has been rejected : '+reason+'.');
        }
    );
};

module.exports = ZipExtractFile;

