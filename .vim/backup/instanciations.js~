Template.InstanciationsPage.onCreated(function() {
    this.app = new ReactiveVar(null);
    this.version = new ReactiveVar(null);
    this.from = new ReactiveVar("01/02/2018");
    this.to = new ReactiveVar(moment().format('DD/MM/YYYY'));

    this.autorun(() => {
        subMgr.subscribe('user_Apps');

        if( this.app.get() ) {
            subMgr.subscribe('user_AppVersions', { appName: this.app.get() });
        }
    });
});

Template.InstanciationsPage.onRendered(function() {
    $('.instanciations-from').datepicker({ format: 'dd/mm/yyyy' });
    $('.instanciations-to').datepicker({ format: 'dd/mm/yyyy' });
});

Template.InstanciationsPage.helpers({
    getApps : function() {
        return Apps.find().fetch();
    },

    getAppVersions : function() {
        var app = Template.instance().app.get();
        return app ? AppVersions.find({ appName: app }).fetch(): [];
    },

    getChartData: function() {
        return {
            app: Template.instance().app.get(),
            version: Template.instance().version.get(),
            from: Template.instance().from.get(),
            to: Template.instance().to.get(),
        };
    },

    today: function() {
        return moment().format('DD/MM/YYYY');
    },
});

Template.InstanciationsPage.events({
    "click .link-to-dashboard" : function(e, t) {
        Router.go('DashboardPage');
    },

    "change .select-app" : function(e, t) {
        var appId = $(e.target).val();
        if( appId === "all" ) {
            t.app.set(null);
        }
        else {
            var app = Apps.findOne(appId);
            t.app.set(app.name);
        }
    },

    "change .select-version" : function(e, t) {
        var versionId = $(e.target).val();
        if( versionId === "all" ) {
            t.version.set(null);
        }
        else {
            var version = AppVersions.findOne(versionId);
            t.version.set(version.appVersion);
        }
    },

    "change .instanciations-from" : function(e, t) {
        e.preventDefault();
        t.from.set($(e.target).val());
    },

    "change .instanciations-to" : function(e, t) {
        e.preventDefault();
        t.to.set($(e.target).val());
    }
});
