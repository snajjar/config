import { $, env, UIComponent } from '@dualbox/dualbox';
var pkgDesc = require('../package.json');

if( env.browser ) {
    require('@dualbox/dualbox-lib-bootstrap');  // require bootstrap to work
    require('@dualbox/dualbox-lib-bootstrap-slider');
    require('./BootstrapDynamicSlider.css');
}

class BootstrapDynamicSlider extends UIComponent {
    constructor(pkgDesc, appDesc, attrs) {
        super(pkgDesc, appDesc, attrs)
        this.val = null;
        this.div = null;

        this.attr = {};

        var that = this;
        Object.keys(pkgDesc.dualbox.attr).forEach(function (key) {
            that.attr[key] = appDesc.attr[key] !== undefined ? appDesc.attr[key]  : pkgDesc.dualbox.attr[key].value;
        });

        this.repeat = false;
        this.interval = null;
        this.interruptedPlay = false;

        this.btnPlay = null;
        this.btnPause = null;
        this.btnRepeat = null;
    }

    registerEvents() {
        super.registerEvents();
        this.registerUIEvent("setAttr", this.setAttr.bind(this));
        this.registerUIEvent("pause", this.onPauseClick.bind(this));
        this.registerUIEvent("play", this.onPlayClick.bind(this));
        this.registerUIEvent("setValue", this.setValue.bind(this));
    }

    stop() {
        super.stop();
        this.onPauseClick();
    }

    setAttr(e) {
        var attr = e.args;
        var that = this;
        Object.keys(attr).forEach(function (key) {
           that.attr[key] = attr[key];
        });

        var preval = this.val;

        $(this.div).find('input').prop("min", attr.min );
        $(this.div).find('input').prop("max", attr.max );
        $(this.div).find('input').prop("step", attr.step );

        this.attr.min = attr.min;
        this.attr.max = attr.max;
        this.attr.step = attr.step;

        this.val = parseFloat($(this.div).find('input').dbSlider('getValue'));

        if(preval !== this.val){
            this.onChange();
        }
    }

    setValue(data){
        if(data.args !== this.val){
            $(this.div).find('input').dbSlider('setValue',data.args);
            this.onChange();
        }
    }

    onReady() {
        this.emit('data', { "result" : this.val });
    }

    disable() {
        $(this.div).prop('disabled', true);
    }

    enable() {
        $(this.div).prop('disabled', false);
    }

    hide() {
        $(this.div).hide();
    }

    show() {
        $(this.div).show();
    }

    import( value ) {
        this.val = value;
        $(this.div).find('input').dbSlider('setValue', value);
        this.onChange();
    }

    buildTxtString(val){

        var perc_disp = this.val*100;
        if(this.attr.step/0.01 === Math.round(this.attr.step/0.01)){
            perc_disp = Math.round(perc_disp);
        }else if(this.attr.step/0.001 === Math.round(this.attr.step/0.001)){
            perc_disp = Math.round(perc_disp*10)/10;
        }else if(this.attr.step/0.0001 === Math.round(this.attr.step/0.0001)){
            perc_disp = Math.round(perc_disp*100)/100;
        }
        return this.attr.prefix +
            this.attr.format === "percent" ? perc_disp + "%": this.val.toString() +
            this.attr.suffix;

    }

    onChange(e, ui) {
        var old_val = this.val;
        if(ui){
            this.val = parseFloat(ui.value);
        }else{
            this.val = parseFloat($(this.div).find('input').dbSlider('getValue'));
        }
        var txt = this.buildTxtString();
        $(this.div).find('.slider-val').text( txt );
        if(old_val !== this.val){
            this.trigger({ "result" : this.val });
        }
    }

    onSlideStart(e,ui){
        if(this.interval){
            clearInterval(this.interval);
            this.interval = null;
            this.interruptedPlay = true;
        }else{
            this.interruptedPlay = false;
        }
    }
    onSlideStop(e,ui){
        this.onChange();
        if(this.interruptedPlay){
            this.onPlayClick();
            this.interruptedPlay = false;
        }

    }

    onPlayClick(e) {
        this.btnPlay.hide();
        this.btnPause.show();
        var that = this;
        if(this.interval === null){

            // If we have already processed all the line,
            // restart from the beginning.
            if(this.val === this.attr.max){
                that.setValue(that.attr.min);
            }

            this.interval = setInterval(function(){
                    if(that.val < that.attr.max){
                        that.setValue({args:Math.min(that.val+that.attr.step, that.attr.max)});
                    }else if(that.val === that.attr.max){
                        if(that.repeat){
                            that.setValue({args:that.attr.min});
                        }else{
                            that.onPauseClick();
                        }
                    }
                },
                this.attr.interval
            );
        }
    }

    onPauseClick(e) {
        this.btnPlay.show();
        this.btnPause.hide();
        clearInterval(this.interval);
        this.interval = null;
    }

    onRepeatClick(e) {
        this.repeat = !this.repeat;
        if(this.repeat){
            this.btnRepeat.addClass("db-dynamic-slider-btn-repeat-active");
        }else{
            this.btnRepeat.removeClass("db-dynamic-slider-btn-repeat-active");
        }
    }

    static attachTo(appDesc, attrs, div) {
        // build slider from package.json desc
        var slider = new BootstrapDynamicSlider(pkgDesc, appDesc, attrs);
        var input = $('<input/>', {
            id:    slider.attr.id
        });

        slider.val = parseFloat(slider.attr.value);
        var txt = slider.buildTxtString();

        // instanciate div from app.json parameters
        slider.btnPlay = $('<button/>', {
            type:  'text',
            class: 'dualbox btn btn-sm btn-primary',
        }).append("<i class='glyphicon glyphicon-play'></i> ");
        slider.btnPause = $('<button/>', {
            type:  'text',
            class: 'dualbox btn btn-sm btn-primary db-dynamic-slider-btn-pause',
        }).append("<i class='glyphicon glyphicon-pause'></i> ");
        slider.btnPause.hide();
        slider.btnRepeat = $('<button/>', {
            type:  'text',
            class: 'dualbox btn btn-sm btn-default db-dynamic-slider-btn-repeat',
        }).append("<i class='glyphicon glyphicon-refresh'></i> ");

        if(slider.attr.repeatTip){
            slider.btnRepeat.attr("data-toggle","tooltip");
            slider.btnRepeat.attr("title",slider.attr.repeatTip);
        }

        slider.btnPlay.click(slider.onPlayClick.bind(slider));
        slider.btnPause.click(slider.onPauseClick.bind(slider));
        slider.btnRepeat.click(slider.onRepeatClick.bind(slider));

        slider.div =
            $('<div/>', { class : "dualbox form-group db-dynamic-slider-div" }).append(
                $('<label/>', { class: "dualbox", style: "width: 100%;" }).append(
                    $('<span/>', { class: "dualbox", text: slider.attr.label }),
                    $('<span/>', { class: 'dualbox slider-val', text: txt, style: "float: right;" })
                ),
                slider.btnPlay,
                slider.btnPause,
                input,
                slider.btnRepeat
            );

        input.dbSlider({
            min:   slider.attr.min,
            max:   slider.attr.max,
            step:  slider.attr.step,
            formatter: function(value) {
                return value;
            }
        }).on('slideStop', slider.onSlideStop.bind(slider));

        input.on('slideStart', slider.onSlideStart.bind(slider));

        if(slider.attr.triggerOnSlide){
            input.on('slide', slider.onChange.bind(slider));
        }
        input.dbSlider('setValue', slider.attr.value)

        // append to param div and return the slider
        $(div).append(slider.div);
        if( slider.attr.hidden ) {
            $(slider.div).hide();
        }

        return slider;
    }
}

module.exports = BootstrapDynamicSlider;
